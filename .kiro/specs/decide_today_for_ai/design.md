# 設計ドキュメント

## 目的
自由記述の条件入力と登録済みデータを生成AIに渡し、最大5件の候補と理由を返す提案機能に刷新する。スコアリングによる一次候補選定は廃止し、判断は生成AIに一任する。

## スコープ
### 対象
- 自由記述条件入力 UI と提案結果表示
- 提案 API の I/F 改修（自由記述条件）
- 生成AI 連携（候補選定 + 理由生成）
- 「行った理由」入力 UI の追加（登録/編集画面）

### 対象外
- 外部サービスからの新規店舗探索
- アプリによる最終決定
- 他ユーザ共有

## 全体構成
- フロントエンドで自由記述条件の入力と提案結果表示を提供
- バックエンドで登録済みのお店データを取得し、生成AIで最大5件に絞り込み + 理由生成
- 失敗時はエラーを返却し、UI で再試行を促す

## 画面/UX 設計
### 画面構成
- `/decide`：条件入力と提案結果を同一画面で表示

### 条件入力
- 入力項目: 自由記述 1 項目
- 入力必須（空欄では提案を実行できない）
- 実行ボタン: 「提案する」
- 補足文: 「例: 今日は軽めで、静かな雰囲気」など
- 未入力時は送信不可とし、入力を促すエラーメッセージを表示する

### 提案結果
- 最大5件をリスト形式で表示
- 各候補に提案理由を表示
- 5件未満の場合は件数メッセージを表示
- 0件の場合は条件変更の案内を表示
- 実行中はローディング表示
- 失敗時はエラーメッセージと再試行ボタンを表示

### 登録・編集画面の変更
- 追加情報に「行った理由」入力欄を追加
- 「次も同条件なら行くか」は UI に含めない
- 入力エラー時も「行った理由」の入力値を保持する

## API 設計
### エンドポイント
- `POST /api/recommendations`

### リクエスト
```json
{
  "condition_text": "今日は軽めで、駅近。静かな雰囲気。"
}
```

### レスポンス（成功）
```json
{
  "condition_text": "今日は軽めで、駅近。静かな雰囲気。",
  "recommendations": [
    {
      "place": {
        "id": 1,
        "name": "店名",
        "tabelog_url": "https://tabelog.com/...",
        "visit_status": "not_visited",
        "genre": "和食",
        "area": "渋谷",
        "price_range": "3000-5000",
        "note": null,
        "visit_reason": "ランチで入りやすそう",
        "revisit_intent": "unknown",
        "created_at": "2026-01-04T00:30:00Z",
        "updated_at": "2026-01-04T01:15:00Z"
      },
      "reason": "駅近で軽めのランチに向いていそう。"
    }
  ]
}
```

### エラー
- 500: 提案生成失敗（OpenAI 連携失敗・出力不正含む）

## バックエンド設計
### 提案フロー
1. `condition_text` を受け取る（空文字不可）
2. `Place` 全件を取得（並び順は `updated_at` 降順）
3. 生成AIに候補一覧と条件を渡し、最大5件を選定 + 理由生成
4. 正常ならレスポンス返却、失敗時は 500 を返す

### 生成AI 入力設計
- `condition_text` を最重要の判断材料として明示
- 候補一覧には以下を含める
  - id / name / genre / area / price_range / visit_status / visit_reason / note
- `revisit_intent` は将来用途のため入力に含めない
- 出力は JSON（id, reason）の配列
- 件数は最大5件、候補外 ID は破棄
- 理由文には `condition_text` に含まれる要素を必ず反映するように指示する

### OpenAI 連携
- バックエンドで実行
- モデル/温度は既存設定を踏襲
- 出力が不正・空の場合は失敗として扱う（フォールバック廃止）
- 既存のスコアリング（`RecommendationService`）は廃止し、全件を OpenAI の選定対象とする

## フロントエンド設計
### 画面
- `DecideTodayScreen`
  - 自由記述入力（textarea）
  - 提案結果リスト（理由付き）
  - ローディング/エラー/0件表示
  - 未入力時は送信不可 + エラーメッセージ表示

### API クライアント
- `recommendPlaces` を `condition_text` 送信に変更

### 型定義
- `RecommendationConditions` を `condition_text` のみに変更
- 登録/編集フォームの `FormState` に `visit_reason` を追加

### 状態管理
- `condition_text`: 入力値
- `recommendations`: 結果配列
- `isLoading`: 実行中
- `error`: 失敗時メッセージ
- `validationError`: 未入力時の入力促し

## データモデル設計
- 追加カラムは不要（`visit_reason` は既存カラムを使用）
- 既存カラムの利用
  - `visit_reason`: 生成AI の主要判断材料
  - `note`: 補足情報として利用

## エラー設計
- API 失敗時: 「提案に失敗しました。再試行してください。」を表示
- 0件時: 「条件を変えて試してください」を表示
- 未入力時: 「条件を入力してください」を表示し、送信をブロックする

## テスト方針
### Backend（RSpec）
- `condition_text` を受け取り、最大5件が返る
- OpenAI 出力が不正/空のとき 500 が返る
- 返却される提案は候補集合内のみ

### Frontend（Vitest）
- 自由記述入力→提案表示ができる
- ローディング/失敗/0件表示
- 提案理由が表示される
- 登録/編集フォームで「行った理由」が送信される

## 依存関係
- OpenAI API（候補選定 + 理由生成）
- 既存 Place モデル

## 設定/運用
- OpenAI API キーはプロジェクトルートの `openai_apikey` ファイルから読み込む
- `openai_apikey` は機密情報のため Git 管理対象外

## 未決定事項
- 候補件数が非常に多い場合の入力制限（必要に応じて上限を設ける）
