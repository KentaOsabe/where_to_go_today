# 設計ドキュメント

## 目的
今日の条件入力をもとに、登録済みの中から一次候補をルールベースで選定し、OpenAI による絞り込みと理由生成で最大5件を提示できるようにする。

## スコープ
### 対象
- 条件入力フォーム（ジャンル/エリア/予算帯）
- ルールベースの一次候補選定ロジック（最大10件）
- OpenAI による絞り込み（最大5件）と理由生成
- 提案結果の表示（理由付き）
- OpenAI フォールバック時の提案/理由表示
- 提案実行中/失敗/0件時のUI

### 対象外
- 外部サービスからの新規店舗探索
- アプリによる最終決定
- 他ユーザ共有

## 全体構成
- フロントエンドで条件入力と提案結果表示を提供
- バックエンドで提案ロジックと理由生成を実行
- ルールベースで一次候補（最大10件）を選定し、OpenAI API で最大5件に絞り込み + 理由文生成を行う

## 画面/UX設計
### 画面構成
- `/decide`：条件入力と提案結果を同一画面で表示
- `PlacesListScreen` に「今日どこ行く？」導線（ボタン/リンク）を追加

### 条件入力
- 入力項目: ジャンル / エリア / 予算帯（すべて任意）
- 入力なしでも提案実行可能
- 実行ボタン: 「提案する」

### 提案結果
- 最大5件をカード/リスト形式で表示
- 各候補に提案理由を表示
- 5件未満の場合は「現在 N 件を提案しています」を表示
- 0件の場合は「条件を変えて再試行」を案内
- 実行中はローディング表示
- 失敗時はエラーメッセージと再試行ボタンを表示

## 提案ロジック設計
### 候補集合
- `Place` 全件（登録済みのみ）

### スコアリング（ルールベース）
- 基本スコア: 0
- 条件一致（部分一致/大文字小文字無視で判定）
  - ジャンル一致: +2
  - エリア一致: +2
  - 予算帯一致: +1
- 評価情報
  - `revisit_intent` が `yes`: +2
  - `revisit_intent` が `no`: -2
  - `visit_reason` が存在: +1
- 同点時の並び順
  1. `visit_status` が `not_visited` を優先
  2. `updated_at` が新しい順

### 返却件数
- スコア順に並べ、上位最大10件を一次候補とする
- OpenAI API による絞り込みで最大5件を最終提案とする
- OpenAI API が失敗した場合は一次候補の上位5件を採用する

## API設計
### エンドポイント
- `POST /api/recommendations`

### リクエスト
```json
{
  "genre": "和食",
  "area": "渋谷",
  "price_range": "3000-5000"
}
```

### レスポンス（成功）
```json
{
  "conditions": {
    "genre": "和食",
    "area": "渋谷",
    "price_range": "3000-5000"
  },
  "recommendations": [
    {
      "place": {
        "id": 1,
        "name": "店名",
        "tabelog_url": "https://tabelog.com/...",
        "visit_status": "not_visited",
        "genre": "和食",
        "area": "渋谷",
        "price_range": "3000-5000",
        "note": null,
        "visit_reason": "ランチで良さそう",
        "revisit_intent": "yes",
        "created_at": "2026-01-04T00:30:00Z",
        "updated_at": "2026-01-04T01:15:00Z"
      },
      "reason": "渋谷で和食、予算帯も合っていて再訪したいお店です。"
    }
  ]
}
```

### エラー
- 500: 提案生成失敗
- 429/502: OpenAI 連携失敗時は一次候補の上位5件 + テンプレ理由で成功扱い

## バックエンド設計
### 追加コンポーネント
- `Api::RecommendationsController` を新規追加
- ルールベース提案ロジックを `RecommendationService` に切り出し

### フロー
1. 条件を受け取る
2. Place 全件取得
3. スコアリング → 上位10件を一次候補として抽出
4. OpenAI API で「5件までの絞り込み + 理由生成」（失敗時は上位5件 + テンプレ理由）
5. JSON 返却

### OpenAI 連携
- バックエンドで実行
- 生成対象は「一次候補からの絞り込み」と「理由文」
- ランダム性（毎回同じ結果になりにくい体験）を考慮したプロンプト/温度設定を行う
- 失敗時はテンプレート理由
  - 例: "ジャンル: 和食 / エリア: 渋谷 / 予算帯: 3000-5000 が条件に近い"
 - 返却フォーマットは JSON 固定とし、サーバ側でバリデーションを行う
   - 件数上限（最大5件）を超える場合は切り詰める
   - 一次候補に存在しない ID は破棄する
   - 理由が欠落している場合はテンプレート理由で補完する

## フロントエンド設計
### 画面
- `DecideTodayScreen` を新規追加
  - 条件入力フォーム
  - 提案結果リスト（理由付き）
  - ローディング/エラー/0件表示

### API クライアント
- `recommendPlaces(conditions)` を追加
- 結果型: `success` / `failure`

### 状態管理
- `conditions`: 入力値
- `recommendations`: 結果配列
- `isLoading`: 実行中
- `error`: 失敗時メッセージ

### ルーティング
- `App.tsx` に `/decide` を追加

## データモデル設計
### 追加カラム（Place）
- `visit_reason` (text, optional)
- `revisit_intent` (string, optional: `yes` / `no` / `unknown`)

### 既存カラム利用
- `genre`, `area`, `price_range`, `visit_status`, `note`

## エラー設計
- API 失敗時: 「提案に失敗しました。再試行してください。」を表示
- 0件時: 「条件を変えて試してください」を表示

## テスト方針
### Backend（RSpec）
- 条件なしで一次候補10件以内、最終結果は5件以内が返る
- 条件一致でスコア順に一次候補が並ぶ
- OpenAI 失敗時でも一次候補の上位5件 + テンプレ理由が返る

### Frontend（Vitest）
- 条件入力→提案表示ができる
- ローディング/失敗/0件表示
- 理由文が表示される

## 依存関係
- OpenAI API（一次候補の絞り込み + 理由生成）
- 既存 Place モデル/一覧取得ロジック

## 設定/運用
- OpenAI API キーはプロジェクトルートの `openai_apikey` ファイルから読み込む
- `openai_apikey` は機密情報のため Git 管理対象外とする

## 未決定事項→確定内容
- 提案 API: `POST /api/recommendations`
- 理由生成の責務: バックエンド
- フォールバック理由: 条件一致テンプレート

## 将来拡張
- 条件の追加（距離、営業状況など）
- 提案履歴の保存
- ランダム提案モード
